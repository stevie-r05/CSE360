/*
* DBUsers.cpp
*
*  Created on: Mar 1, 2012
*      Author: Ian
*/
#include "stdafx.h"
#include "DB_Users.h"
#include "timingClass.h"

namespace CSE360Project {

	DB_Users::DB_Users() {
		database_file = "Users.db";
		database_info_file = database_file+".info";

		//Load Data
		this->LoadData<db_user_data >(user_data);
	}

	void DB_Users::ReloadData() {
		this->LoadData<db_user_data >(user_data);
	}

	void DB_Users::ClearData() {
		user_data.clear();
	}
	
	void DB_Users::Update(db_user_data user_data) {
		int vector_index = getVectorIndex(user_data.uid);

		if (vector_index >= 0) {
			this->Delete(user_data.uid);

			this->user_data.push_back(user_data);
			record_change_count++;

			this->Write();
		}
		else
		{
			this->Insert(&user_data);
		}
	}

	void DB_Users::Delete(int uid) {
		int vector_index = getVectorIndex(uid);

		if (vector_index >= 0) {
			user_data.erase(user_data.begin()+vector_index);
			record_change_count++;

			this->Write();
		}
	}

	int DB_Users::Insert(db_user_data *user_data) {
		//Auto-assign UID
		user_data->uid = ++lastID;

		//We need to error check, if they are already a user, do nothing.
		this->user_data.push_back(*user_data);
		record_change_count++;

		this->Write();
		
		return lastID;
	}

	bool DB_Users::validateUser(string username, string password) {
		int vector_index = getVectorIndex(username);

		return (vector_index >= 0 && password.compare(user_data[vector_index].password) == 0);
	}

	bool DB_Users::checkSecurityAnswer(string username, string answer) {
		int vector_index = getVectorIndex(username);

		return (vector_index >= 0 && answer.compare(user_data[vector_index].securityAnswer) == 0);
	}

	user_role_t DB_Users::getUserRole(int uid) {
		return user_data[getVectorIndex(uid)].userRole;
	}

	string DB_Users::getUsername(int uid) {
		int vector_index = getVectorIndex(uid);

		if (vector_index == -1)
			return "string"

		return user_data[vector_index].username;
		//There is no guarantee size will b eless than uid, what happens if we delete a user?
		//if(uid > user_data.size()){
			//return "none";
		//}else{
		//return user_data[ getVectorIndex(uid) ].username;
		//}
	}

	string DB_Users::getFirstname(int uid) {
		return user_data[ getVectorIndex(uid) ].firstName;
	}

	string DB_Users::getLastname(int uid) {
		return user_data[ getVectorIndex(uid) ].lastName;
	}

	string DB_Users::getSecurityQuestion(string username) {
		int vector_index = getVectorIndex(username);

		return (vector_index >= 0 ? user_data[ vector_index ].securityQuestion : "invalid");
	}

	int DB_Users::getUID(string username) {
		int vector_index = getVectorIndex(username);

		return (vector_index >= 0 ? user_data[vector_index].uid : 0);
	}
	
	db_user_data DB_Users::getUserData(int uid) {
		int vector_index = getVectorIndex(uid);

		return user_data[vector_index];
	}

	int DB_Users::getVectorIndex(string username) {
		for (int i = 0; i < (int) user_data.size(); i++) {
			if (username.compare(user_data[i].username) == 0) {
				return i;
			}
		}

		return -1;
	}

	int DB_Users::getVectorIndex(int uid) {
		for (int i = 0; i < (int) user_data.size(); i++) {
			if (uid == user_data[i].uid) {
				return i;
			}
		}

		return -1;
	}

	void DB_Users::outputAllData() {
		if (!user_data.empty()) {
			for (int i = 0; i < (int) user_data.size(); i++) {
				cout << i+1 << ") ";
				cout << "uid: " << user_data[i].uid << " - "; //User ID - Autogenerated in this class.
				cout << "username: " << user_data[i].username << " - ";
				cout << "Name: " << user_data[i].lastName << ", " << user_data[i].firstName << " - ";
				cout << "role: ";
				switch (user_data[i].userRole) {
				case admin:
					cout << "Admin";
					break;
				case teacher:
					cout << "Teacher";
					break;
				default:
					cout << "Student";
					break;
				}
				cout << endl << endl;
			}
		} else {
			cout << "User Data is empty." << endl;
		}
	}

	void DB_Users::Write(bool force_write) {
		if (record_change_count % record_change_mod_value == 0 || force_write)
			this->WriteData<db_user_data >(user_data);
	}

	DB_Users::~DB_Users() {
		this->Write(true);

		this->ClearData();
	}

} /* namespace CSE360Project */